<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Danh sách đặt vé máy bay</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      #chat-box {
        border: 1px solid #ccc;
        height: 400px;
        overflow-y: auto;
        padding: 10px;
        background: #f9f9f9;
      }
      .user-msg {
        color: blue;
        margin-bottom: 5px;
      }
      .bot-msg {
        color: green;
        margin-bottom: 5px;
      }
      .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
    </style>
  </head>
  <body class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Đặt vé máy bay</h2>
      <a href="{{ url_for('create') }}" class="btn btn-success"
        >+ Thêm đặt vé</a
      >
    </div>

    <!-- Danh sách đặt vé -->
    <div id="booking-table">{% include 'table.html' %}</div>

    <hr />

    <!-- Chat Box -->
    <div class="mb-3">
      <h4>Chat với LLM để quản lý đặt vé</h4>
      <div id="chat-box" class="mb-2"></div>
      <div class="input-group">
        <input
          type="text"
          id="user-input"
          class="form-control"
          placeholder="Nhập tin nhắn..."
        />
        <button class="btn btn-primary" onclick="sendMessage()">Gửi</button>
      </div>
    </div>

    <script>
      async function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value.trim();
        if (!message) return;

        appendMessage("user-msg", message);
        input.value = "";

        const resp = await fetch("/chat_api", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
        });

        const data = await resp.json();
        appendMessageWithAudio("bot-msg", data.response, data.audio_id);

        if (
          data.response.includes("Đã tạo") ||
          data.response.includes("Đã cập nhật") ||
          data.response.includes("Đã xóa")
        ) {
          setTimeout(() => {
            fetch("/table")
              .then((res) => res.text())
              .then((html) => {
                document.getElementById("booking-table").innerHTML = html;
              });
          }, 1000);
        }
      }

      function appendMessage(className, message) {
        const chatBox = document.getElementById("chat-box");
        const msgDiv = document.createElement("div");
        msgDiv.className = className;
        msgDiv.innerHTML = marked.parse(message);
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function appendMessageWithAudio(className, message, audioId) {
        const chatBox = document.getElementById("chat-box");
        const msgDiv = document.createElement("div");
        msgDiv.className = className;

        // SỬA TẠI ĐÂY: dùng markdown
        const textSpan = document.createElement("span");
        textSpan.innerHTML = marked.parse(message); // KHÔNG replace dấu chấm nữa
        msgDiv.appendChild(textSpan);

        if (audioId) {
          const playBtn = document.createElement("button");
          playBtn.textContent = "▶️ Phát audio";
          playBtn.style.marginLeft = "10px";
          playBtn.className = "btn btn-sm btn-outline-primary";
          playBtn.onclick = () => fetchAudioAndPlay(audioId);
          msgDiv.appendChild(playBtn);
        }

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function fetchAudioAndPlay(audioId) {
        try {
          const response = await fetch(
            `/get_audio?id=${encodeURIComponent(audioId)}`
          );
          if (!response.ok) {
            alert("Lấy audio thất bại");
            return;
          }

          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          audio.play();

          audio.onended = () => {
            URL.revokeObjectURL(audioUrl);
          };
        } catch (err) {
          console.error("Lỗi fetch audio:", err);
          alert("Có lỗi xảy ra khi lấy audio");
        }
      }
    </script>
  </body>
</html>
